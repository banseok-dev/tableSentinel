syntax = "proto3";

package com.tbsen.proto;

option java_multiple_files = true;
option java_outer_classname = "FilterProto";

// Enums (공통)
enum AgentState {
    STATE_UNKNOWN = 0;
    STATE_RUNNING = 1;
    STATE_WARNING = 2;
    STATE_ERROR = 3;
}

enum ActionType {
    ACTION_UNKNOWN = 0;
    ACTION_ADD = 1;
    ACTION_DELETE = 2;
}


// XDP Domain Messages //

// XDP Mode 분류
enum XdpMode {
    XDP_MODE_UNKNOWN = 0;
    XDP_MODE_NATIVE = 1;
    XDP_MODE_SKB = 2;
    XDP_MODE_OFFLOAD = 3;
}

// XDP 명령 통합 래퍼
message XdpCommand {
    ActionType action = 1;
    string target_ip = 2;
    string target_mac = 3;
    string mode = 4; // {"src", "dst"}
    string interface_name = 5; // 인터페이스 로드/언로드
    XdpMode interface_mode = 6; // 인터페이스 스펙 정의
}


// Nftables Domain Messages //

// nftables 룰 제어
message NftCommand {
    ActionType action = 1;
    string chain = 2;       // INPUT, OUTPUT, FORWARD 등
    string target_ip = 3;
    string protocol = 4;    // tcp, udp
    string port = 5;        // port
    string handle = 6; // delete 옵션시 handle number 필요 
}


// Main Command Structure //

// 백엔드 -> 에이전트 명령
message Command {
    string command_id = 1;
    
    // 명령 분기
    oneof payload {
        XdpCommand xdp = 2;
        NftCommand nft = 3;
    }
}

// Response & Status
message CommandResponse {
    string command_id = 1;
    bool success = 2;
    string message = 3;
}

message InterfaceMetrics {
    string interface_name = 1;
    bool xdp_attached = 2; // 프론트에서 분기(리포트 확인받은 후 처리) - 추후 사용
    uint64 drop_count = 3;
    uint64 pass_count = 4;
}

message XdpInterfaceInfo {
    string name = 1;
    string mode = 2;
    uint64 drop_count = 3;
    uint64 pass_count = 4;
}

message AgentStatus {
    string uuid = 1;
    int64 timestamp = 2;
    string hostname = 3;
    string ip_address = 4;
    repeated XdpInterfaceInfo xdp_details = 5;
    XdpMode xdp_mode = 6;
    string nftables_raw_json = 7;
}

message AgentIdentity {
    string uuid = 1;
    string hostname = 2;
    string agent_version = 3;
    string ip_address = 4;
}

// Services //
service FilterAgent {
    // 등록 (에이전트 -> 서버)
    rpc RegisterAgent (AgentIdentity) returns (CommandResponse);
    // 상태보고 (에이전트 -> 서버)
    rpc ReportStatus (stream AgentStatus) returns (CommandResponse);
    // 명령 수신 (서버 -> 에이전트)
    rpc SubscribeCommands (AgentIdentity) returns (stream Command);
    // 명령 결과 보고 (에이전트 -> 서버)
    rpc ReportCommandResult (CommandResponse) returns (CommandResponse);
}